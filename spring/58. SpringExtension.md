## Extension
- JUnit 5에서 단위 테스트 코드를 확장하고 사용자 정의 기능을 추가할 수 있는 메커니즘
	- Test class, method를 확장할 수 있다. 
	- 테스트 이벤트, Life Cycle에 관여하게 된다.
	- 우리가 사용하는 `@SpringBootTest`, `@WebMvcTest`, `@DataJpaTest`에도 `@ExtendWith(SpringExtension.clas)`가 포함되어 있다.
- JUnit 4의 Runner는 단일 상속 구조라 여러 기능 조합이 불가능 했음
- Store를 통한 상태 공유


SpringExtension
```java
public class SpringExtension implements BeforeAllCallback,
AfterAllCallback,TestInstancePostProcessor, BeforeEachCallback,
AfterEachCallback,BeforeTestExecutionCallback,
AfterTestExecutionCallback, ParameterResolver {
```

### Extension 실행 순서
1. [BeforeAllCallback]
2. `@BeforeAll`
3. 테스트 인스턴스 생성
4. [TestInstancePostProcessor] -> SpringExtesion이 DI 수행
5. [BeforeEachCallback]
6. `@BeforeEach`
7. [BeforeTestExecutionCallback]
8. `@Test` 실행
9. [AfterTestExecutionCallback]
10. `@AfterEach`
11. [AfterEachCallback]
12. [TestInstancePreDestroyCallback]
13. `@AfterAll`
14. [AfterAllCallback]

### ExtensionContext
```java
// org.junit.jupiter.api.extension.ExtensionContext
public interface ExtensionContext {
    
    // 테스트 메타데이터
    Optional<Class<?>> getTestClass();
    Optional<Object> getTestInstance();
    Optional<Method> getTestMethod();
    
    // 계층 구조
    Optional<ExtensionContext> getParent();
    ExtensionContext getRoot();
    
    // 저장소 (Extension 간 데이터 공유)
    Store getStore(Namespace namespace);
    
    // 설정 파라미터
    Optional<String> getConfigurationParameter(String key);
}
```


## SpringExtension
### SpringExtension 기본 구조
```java
public class SpringExtension implements 
BeforeAllCallback, //클래스 레벨 초기화
AfterAllCallback, //클래스 레벨 정리
TestInstancePostProcessor,  //DI 수행
BeforeEachCallback, //메소드 전 준비
AfterEachCallback, //메소드 후 정리
BeforeTestExecutionCallback, //트랜잭션 시작 등
AfterTestExecutionCallback,  //트랜잭션 커밋/롤백
ParameterResolver { //메소드 파라미터 주입


private static final ExtensionContext.Namespace TEST_CONTEXT_MANAGER_NAMESPACE = Namespace.create(new Object[]{SpringExtension.class});  
private static final ExtensionContext.Namespace AUTOWIRED_VALIDATION_NAMESPACE = Namespace.create(new Object[]{SpringExtension.class.getName() + "#autowired.validation"});  
private static final String NO_VIOLATIONS_DETECTED = "";  
private static final ExtensionContext.Namespace RECORD_APPLICATION_EVENTS_VALIDATION_NAMESPACE = Namespace.create(new Object[]{SpringExtension.class.getName() + "#recordApplicationEvents.validation"});  
private static final List<Class<? extends Annotation>> JUPITER_ANNOTATION_TYPES = List.of(BeforeAll.class, AfterAll.class, BeforeEach.class, AfterEach.class, Testable.class);  
private static final ReflectionUtils.MethodFilter autowiredTestOrLifecycleMethodFilter;
```


### 책임
1. JUnit-Spring 브릿지: JUnit 생명주기 
   → Spring TestContext Framework 연결
2. TestContextManager 관리
   → 클래스당 1개 생성 및 캐싱
   → ExtensionContext.Store 활용
3. ApplicationContext 로딩 조율
   → 캐시 확인 -> 재사용 혹은 새로 생성
   → ContextLoader 전략 위임
4. DI 위임
   → TestInstancePostProcessor에서 수행
   → DependencyInjectionTestExecutionListner 활용
5. 트랜잭션 관리
   → BeforeTestExtension에서 시작
   → AfterTestExecution에서 롤백