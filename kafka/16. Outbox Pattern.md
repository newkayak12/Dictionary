### 분산 시스템 일관성 문제

**Dual Write Problem**
- 하나의 비즈니스 액션이 두 개의 다른 시스템에 변경 필요
- Database (ACID 보장) + Message Queue (별도 시스템)
- **둘 다 성공하거나 둘 다 실패해야 하는데 원자성 보장 불가**

**실패 시나리오:**
- DB 저장 성공 → 네트워크 장애로 Kafka 전송 실패
- Kafka 전송 성공 → DB 커밋 실패
- 애플리케이션 크래시 (DB 커밋과 Kafka 전송 사이)

### 2PC (Two-Phase Commit) 시도

2PC 동작 방식:
```
Phase 1 (Prepare/Vote):
Transaction Coordinator → All Participants: "커밋할 준비됐나?"
PostgreSQL → Coordinator: "YES" (prepared 상태로 대기)
Kafka → Coordinator: "YES" (prepared 상태로 대기)

Phase 2 (Commit):
Coordinator → All Participants: "실제 커밋해"
PostgreSQL: 실제 커밋 수행
Kafka: 실제 메시지 전송
```

2PC 문제점:
- Blocking Protocol: Phase 1에서 모든 참여자가 잠금 상태로 대기
- Coordinator SPOF: 코디네이터 죽으면 모든 참여자 무한 대기
- 성능 저하: 네트워크 라운드트립 최소 3번 (prepare, vote, commit)
- Partial Failure: 일부 참여자만 실패 시 복구 복잡
- Timeout Handling: 무응답 참여자에 대한 복잡한 타임아웃 로직


### Outbox Pattern 접근법

핵심 철학: 분산 트랜잭션 회피
- 이벤트를 별도 시스템이 아닌 **동일 DB에 저장**
- **단일 ACID 트랜잭션**으로 비즈니스 데이터 + 이벤트 함께 처리
- **비동기 발행**으로 성능과 가용성 확보

구성
- Outbox Event 저장 테이블
- 비즈니스 로직 수행 ➡️ 테이블 변경과 함께 Event 저장도 진행
- Event를 비동기로 발행
- 주기적으로 Event 저장 테이블 확인하고 누락된 내용 진행
 
---
### 1. Publisher 패턴

- **Polling**: 스케줄러가 주기적 스캔 (1초 간격)
- **CDC**: Debezium으로 DB 변경 로그 실시간 감지
- **Push**: DB 트리거나 stored procedure 활용

### 2. 순서 보장

- **Global Order**: 전체 이벤트에 대한 순서 (sequence number)
	- Sequence Number: outbox_event에 순차적 ID 발급
	- Single Publisher: 하나의 Publisher가 ID 발급
	- Trade-off: 순서 보장은 되지만 처리량에 한계가 있음
- **Per-Aggregate Order**: 동일 엔티티 내에서만 순서 보장
	- Aggregate ID: 동일 사용자/ 주문 이벤트만 순서 보장
	- Partition Key 활용: Kafka에 순서 유지를 맡김
	- 병렬 처리 : 다른 Aggregate는 동시 처리 가능
- **Causal Order**: 인과관계 있는 이벤트 간 순서
	- Happens-before 관계: A 이벤트가 B 이벤트의 원인인 경우
	- Vector Clock: 분산 시스템에서 인과관계 추적
	- Dependency Graph: 이벤트 간 의존성 명시적 관리

### 3. 신뢰성 보장

- **At-least-once**: 중복 발행 허용, 누락 방지
	- Publisher 재시작: 마지막 published=false부터 재발행
	- Kafka 장애: Publisher가 재시도하여 결국 전송
	- 중복 허용: 같은 이벤트가 여러 번 발행될 수 있음
- **Idempotent Consumer**: 수신측에서 중복 처리
	- Message ID: 각 이벤트에 고유 식별자 부여
	- Processed Table: 처리 완료된 메시지 ID 기록
	- Skip Logic: 이미 처리된 메시지는 건너뛰기
- **Deduplication**: 발행측에서 중복 감지 및 제거
	- Publisher Level: 발행 전 중복 체크
	- Consumer Level: 수신 후 중복 체크
	- Kafka Level: 멱등성 Producer 설정

### 4. 성능 최적화

- **Batch Publishing**: 여러 이벤트 묶어서 전송
- **Partitioned Outbox**: 대용량 처리를 위한 테이블 분할
- **Cleanup Strategy**: 발행 완료 이벤트 아카이브/삭제

