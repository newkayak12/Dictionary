### ZooKeeper가 뭔데?

- **분산 코디네이션 서비스** - 여러 서버가 협력할 때 필요한 "중재자" 역할
- **설정 중앙 관리** - 분산된 서버들의 설정 정보를 한 곳에서 관리
- **리더 선출** - 여러 서버 중 누가 리더인지 안전하게 결정
- **데이터 동기화** - 모든 서버가 같은 정보를 갖도록 보장
- **Apache 프로젝트** - Hadoop 생태계에서 시작, 분산 시스템의 "표준" 코디네이터
### ZooKeeper 내부 구조

- **앙상블 클러스터** - 보통 3, 5, 7대의 홀수 서버로 구성
- **트리 구조 데이터** - 파일시스템 같은 계층형 데이터 저장 (/kafka/brokers/ids/1)
- **합의 알고리즘** - ZAB(ZooKeeper Atomic Broadcast)로 데이터 일관성 보장
- **Watch 메커니즘** - 데이터 변경 시 클라이언트에게 즉시 알림
### ZooKeeper 시대: 왜 필요했나?

- **분산 코디네이션 문제** - Kafka 브로커들이 서로 누가 리더인지, 어떤 토픽이 있는지 알아야 함
- **메타데이터 저장소 필요** - 토픽 설정, 파티션 배치, 브로커 상태 정보 중앙 관리 필요
- **리더 선출 메커니즘** - 브로커 장애 시 새 리더를 안전하게 선출할 합의 알고리즘 필요
- **일관성 보장** - 모든 브로커가 동일한 메타데이터 상태를 가져야 함
- **ZooKeeper 선택** - 이미 검증된 분산 코디네이션 서비스, Hadoop 생태계에서 널리 사용
### ZooKeeper 방식 동작 구조

- **이중 클러스터** - Kafka 클러스터 + ZooKeeper 앙상블 (보통 3, 5대)
- **메타데이터 흐름** - 브로커 → ZooKeeper 등록 → 다른 브로커들이 ZooKeeper에서 조회
- **리더 선출** - ZooKeeper가 브로커 리더 선출 및 Controller 선출 담당
- **감시 메커니즘** - ZooKeeper Watch를 통해 메타데이터 변경사항 브로커들에게 알림

### 운영하다 보니 문제점들 발견

- **운영 복잡도** - 두 개 시스템을 동시에 관리해야 하는 부담
- **성능 병목** - 모든 메타데이터 변경이 ZooKeeper를 거쳐야 해서 지연 발생
- **확장성 한계** - ZooKeeper 성능 때문에 파티션 수 늘리기 어려움
- **장애 전파** - ZooKeeper 문제가 Kafka 전체에 영향


---

### KRaft가 뭐야?

- **이름의 뜻** - Kafka + Raft, 즉 Kafka에서 Raft 알고리즘을 쓰겠다는 의미
- **목적** - ZooKeeper 없이 Kafka가 스스로 클러스터를 관리하게 만들자
- **핵심 아이디어** - "우리가 직접 메타데이터 관리하면 더 간단하지 않을까?"
- **언제 나왔나** - Kafka 2.8 (2021년)부터 실험적 기능, 3.3 (2022년)부터 프로덕션 권장

### 왜 이런 걸 만들었나?

- **운영 상 고충** - Kafka 장애인지 ZooKeeper 장애인지 구분하기 어려움
- **성능 요구사항** - 더 많은 파티션, 더 빠른 메타데이터 변경 필요
- **단순함의 가치** - 하나의 시스템이 두 개보다 관리하기 쉬움
- **의존성 최소화** - 다른 시스템에 의존하지 않고 독립적으로 동작

### Raft 알고리즘이 뭔데?

- **분산 합의 알고리즘** - 여러 서버가 같은 결정을 내리도록 하는 방법
- **리더 중심** - 한 명의 리더가 결정하고 나머지는 따라가는 구조
- **과반수 원칙** - 절반 이상이 동의해야 결정 확정
- **ZooKeeper보다 단순** - 이해하기 쉽고 구현하기 간단
- **검증된 알고리즘** - etcd, Consul 등에서 이미 많이 사용

### KRaft는 Raft를 어떻게 활용하나?

- **Controller들이 Raft 그룹** - 3~5개의 Controller가 하나의 Raft 클러스터 구성
- **메타데이터가 로그** - 토픽 생성, 브로커 추가 등 모든 변경사항을 로그로 기록
- **리더가 명령 내림** - Controller 리더가 "이 브로커가 이 파티션의 리더야" 같은 결정
- **팔로워들이 복제** - 나머지 Controller들이 같은 로그를 가지고 있음