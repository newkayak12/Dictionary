## 7. Batch Processing이란?

### 개념

- 개별 메시지를 **즉시 전송하지 않고 모아서** 일괄 처리
- **네트워크 효율성**을 위한 핵심 메커니즘
- Producer 내부의 **RecordAccumulator**가 배치 관리

### 왜 배치로 처리하는가?

- **네트워크 오버헤드 감소**: TCP/HTTP 헤더 비용 분산
- **처리량 증가**: 한 번에 많은 메시지 전송
- **Broker 부하 감소**: 요청 횟수 감소

### 배치 생성 조건

- **크기 기반**: batch.size에 도달하면 전송
- **시간 기반**: linger.ms 시간이 지나면 전송
- **둘 중 먼저 만족하는 조건**에 따라 전송

### 배치 단위

- **Partition별**: 각 Partition마다 별도 배치
- **Broker별**: 동일 Broker의 여러 Partition 함께 전송
- **압축 단위**: 배치 전체가 압축 대상

---

### **1. Batch Size 튜닝**

- **작은 배치 (1-8KB)**: 낮은 지연시간, 낮은 처리량
- **큰 배치 (32-64KB)**: 높은 처리량, 높은 지연시간
- **적정 크기**: 메시지 크기와 전송 빈도에 따라 결정

### **2. Linger Time 최적화**

- **linger.ms=0**: 배치 크기만으로 결정 (기본값)
- **linger.ms=5-20ms**: 처리량 우선 시나리오
- **linger.ms=100ms+**: 배치성 워크로드

### **3. Memory Buffer 관리**

- **buffer.memory**: 전체 Producer 메모리 한계
- **max.block.ms**: 버퍼 가득할 때 대기시간
- **메모리 부족 시**: 새로운 메시지 전송 블로킹

### **4. Compression과의 관계**

- **배치가 클수록**: 압축 효율 증가
- **압축 타입별**: snappy(균형), gzip(압축률), lz4(속도)
- **CPU vs Network**: 압축으로 네트워크 절약, CPU 사용량 증가

### **5. 지연시간 최소화 전략**

- **Sticky Partitioning**: 동일 Partition에 연속 전송
- **배치 미완성 전송**: linger.ms로 강제 전송
- **Zero-copy**: OS 레벨 최적화 활용

### **6. 모니터링 지표**

- **Batch Size Avg**: 평균 배치 크기
- **Records per Batch**: 배치당 레코드 수
- **Batch Queue Time**: 배치 대기 시간
- **Request Rate**: 초당 요청 수

### **7. 장애 상황 대응**

- **Partial Batch Send**: 부분 배치 전송 허용
- **Retry Logic**: 배치 단위 재시도
- **Order Preservation**: 실패 시 순서 보장 전략