### 개념

- Consumer Group 내에서 **Partition 할당을 재조정**하는 과정
- Consumer 변경이나 Partition 변경 시 **자동으로 발생**
- 모든 Consumer가 **일시적으로 중단**되는 Stop-the-World 현상

### 언제 발생하는가?

- **Consumer 추가**: 새로운 Consumer가 Group에 참여
- **Consumer 제거**: Consumer가 정상적으로 Group 탈퇴
- **Consumer 장애**: heartbeat 실패로 죽은 것으로 간주
- **Partition 증가**: Topic에 새 Partition 추가

### Rebalancing 과정

```
1. 트리거 발생 (Consumer 변경/Partition 변경)
2. 모든 Consumer 일시 정지
3. Group Coordinator가 새로운 할당 계산
4. 새 할당을 모든 Consumer에게 전달
5. Consumer들이 새 Partition에서 소비 재시작
```

### Stop-the-World 문제

- **전체 Consumer Group 정지**: Rebalancing 중 메시지 처리 불가
- **지연시간 증가**: 수초에서 수분까지 서비스 중단
- **Consumer Lag 증가**: 처리 못한 메시지 누적

---
### **1. Rebalancing 빈도 최소화**

- **안정적인 Consumer 운영**: 불필요한 재시작 방지
- **적절한 Session Timeout**: session.timeout.ms=30000 (기본값)
- **Heartbeat 최적화**: heartbeat.interval.ms=3000
- **처리 시간 관리**: max.poll.interval.ms 내에 처리 완료

### **2. Rebalancing 시간 단축**

- **작은 Consumer Group**: Group 크기가 작을수록 빠름
- **적절한 Partition 수**: 너무 많으면 계산 복잡도 증가
- **Network Latency 최소화**: Consumer와 Broker 간 지연 감소

### **3. Incremental Cooperative Rebalancing**

- **Kafka 2.4+ 기능**: 전체 정지 대신 점진적 재할당
- **Sticky Assignment**: 기존 할당 최대한 유지
- **부분 재할당**: 필요한 Partition만 재배정

### **4. Assignment Strategy 최적화**

- **RoundRobin**: 균등 분배하지만 전체 재할당
- **Range**: Topic별 연속 할당
- **Sticky**: 기존 할당 유지 우선 (권장)
- **Cooperative Sticky**: 점진적 재할당 (최신)

### **5. 모니터링 지표**

- **Rebalancing 빈도**: 시간당 발생 횟수
- **Rebalancing 시간**: 평균 소요 시간
- **Consumer Lag Spike**: 재할당 시 지연 증가
- **Error Rate**: 재할당 실패율

### **6. 운영 전략**

- **Rolling Restart**: Consumer를 하나씩 순차 재시작
- **Blue-Green Deployment**: 새 Consumer Group으로 전환
- **Graceful Shutdown**: 정상적인 종료로 예측 가능한 재할당
- **Capacity Planning**: 여유 Consumer로 재할당 부담 감소

### **7. 장애 상황 대응**

- **Poison Consumer**: 문제 Consumer 격리
- **Split Brain**: Network Partition 시 대응
- **Coordinator 장애**: Backup Coordinator 활용
- **Manual Intervention**: 수동 개입이 필요한 경우