# 실행 계획

옵티마이저는 사용자의 쿼리를 최적화해야 한다. 이를 위해서 MySQL은 통계 정보를 수집하여 튜닝을 진행한다.

## 통계 정보

### 테이블, 인덱스 통계 정보
비용 기반 최적화에서 가장 중요한 것이 통계 정보다. 통계 정보가 부정확하면 쿼리가 산으로 갈 수도 있다. 5.6부터 통계정보가 메모리에서만 관리되는게 아니라 영구적으로
저장하여 관리할 수 있게 됐다. `innodb_index_stats`, `innodb_table_stats`로 확인할 수 있다. 또한 영구적으로 보관할지도 `STATS_PERSISTENT`로 
설정할 수 있다.


```mysql
CREATE TABLE tableTest ( test1 INT PRIMARY KEY , test2 VARCHAR(30))
ENGINE = InnoDB
STATS_PERSISTENT = [DEFAULT | 0 | 1]

-- 0 저장 안 함
-- 1 저장 함
-- DEFAULT 시스템 변수에 따름

```

기본은 ON(1)이다. 물론 테이블 생성 후에도

```mysql
ALTER TABLE ~ STATS_PERSISTENT=1;
```

와 같이 변경할 수도 있다. 이 통계 정보는
1. 테이블이 새로 오픈되는 경우
2. 테이블 레코드가 대량으로 변경되는 경우
3. ANALYZE TABLE 명령이 실행되는 경우
4. `SHOW TABLE STATUS`, `SHOW INDEX FROM ~`이 실행되는 경우
5. InnoDB 모니터가 활성화 되는 경우
6. innodb_stats_on_metadata 시스템 설정이 ON이고 `SHOW TABLE STATUS` 가 실행되는 경우

통계 정보가 갱신되면 쿼리 최적화가 한순간에 달라질 수도 있다. `innodb_stats_auto_recalc`을 꺼서 위 경우 통계 갱신을 막을 수 있다.
`STATS_AUTO_RECALC`을 통해서 설정할 수도 있다. (1은 자동, 0은 `ANALYZE TABLE`에만 반응하도록, DEFAULT는 시스템 변수를 따라간다. )

또한 `innodb_stats_transient_sample_pages`로 샘플링 페이지를 정해서 일부를 가지고 통계를 낼 수도 있으며, `innodb_stats_persistent_sample_pages`로
샘플링해서 저장하는 페이지 수를 정할 수도 있다. 

### 히스토그램

8.0부터 컬럼 데이터 분포도를 참조할 수 있는 히스토그램도 수집한다. 히스토그램은 `ANALYZE TABLE ... UPDATE HISTOGRAM` 명령으로 수동으로 수집, 관리된다. 
종류는 두 가지다.

1. Singleton : 컬럼 값 개별로 레코드 건수를 관리하는 히스토그램 (도수 분포라고도 불린다.)
2. Equi-Height : 컬럼 값의 범위를 균등한 개수로 구분해서 관리하는 히스토그램 (Height-Balanced라고도 불린다.)

싱글톤 히스토그램은 컬럼이 가지는 값 별로 버킷이 할당되며, 높이-균형 히스토그램은 개수가 균등한 컬럼 값의 범위별로 하나의 버킷이 할당된다. 
싱글톤 히스토그램이는 컬럼 값별로 누적된 건수의 비율을 가지고 있다. 높이-균형 히스토그램은 컬럼 값의 각 범위에 대해 레코드 건수 비율이 누적으로 표시된다. (그래프의 기울기가 의미가 있다.)

- sampling-rate :  히스토그램 정보를 수집하기 위해 스캔한 페이지의 비율을 저장한다. 샘플링 비율이 높아질수록 정확한 히스토그램이 되지만 테이블 스캔으로 부하가 늘어난다.
- histogram-type : 히스토그램 종류를 저장한다.
- number-of-buckets-specified : 버킷의 개수를 저장한다. 기본으로 100개 최대 1024개이다.

생성된 히스토그램은 아래와 같이 지울 수 있다.

```mysql
ANALYZE TABLE ~
DROP HISTOGRAM ON ~;
```
단 지우면 쿼리 실행 계획이 달라질 수 있다.


#### 용도
